"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TranslocoExtractKeysWebpackPlugin=void 0;const buildScopeFilePaths_1=require("./helpers/buildScopeFilePaths"),mergeDeep_1=require("./helpers/mergeDeep"),resolveConfig_1=require("./helpers/resolveConfig"),updateScopesMap_1=require("./helpers/updateScopesMap"),keysBuilder_1=require("./keysBuilder"),buildTranslationFile_1=require("./keysBuilder/buildTranslationFile"),extractTSKeys_1=require("./keysBuilder/extractTSKeys"),extractTemplateKeys_1=require("./keysBuilder/extractTemplateKeys"),generateKeys_1=require("./keysBuilder/generateKeys"),initExtraction_1=require("./keysBuilder/initExtraction");let init=!0;class TranslocoExtractKeysWebpackPlugin{constructor(e={}){this.config=resolveConfig_1.resolveConfig(e),this.inlineConfig=e}apply(e){e.hooks.watchRun.tap("TranslocoExtractKeysPlugin",e=>{if(init)return keysBuilder_1.buildTranslationFiles(this.config),void(init=!1);const t={html:[],ts:[]},i=Object.keys(e.watchFileSystem.watcher.mtimes);for(const e of i){let i;e.endsWith(".html")?i="html":!e.endsWith("spec.ts")&&e.endsWith(".ts")&&(i="ts"),i&&t[i].push(e)}let s=initExtraction_1.initExtraction(),r=initExtraction_1.initExtraction();if(t.html.length||t.ts.length){if(t.ts.length){const e=updateScopesMap_1.updateScopesMap({files:i});buildScopeFilePaths_1.buildScopeFilePaths({aliasToScope:e,langs:this.config.langs,outputPath:this.config.output}).forEach(({path:e})=>buildTranslationFile_1.buildTranslationFile(e,{})),r=extractTSKeys_1.extractTSKeys(Object.assign(Object.assign({},this.config),{files:t.ts}))}t.html.length&&(s=extractTemplateKeys_1.extractTemplateKeys(Object.assign(Object.assign({},this.config),{files:t.html})));const e=mergeDeep_1.mergeDeep({},s.scopeToKeys,r.scopeToKeys);Object.keys(e).some(t=>Object.keys(e[t]).length>0)&&generateKeys_1.generateKeys({config:this.config,translationPath:this.config.translationsPath,scopeToKeys:e})}})}}exports.TranslocoExtractKeysWebpackPlugin=TranslocoExtractKeysWebpackPlugin;