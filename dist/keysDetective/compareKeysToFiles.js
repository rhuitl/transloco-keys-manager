"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.compareKeysToFiles=void 0;const transloco_utils_1=require("@ngneat/transloco-utils"),deep_diff_1=require("deep-diff"),flat_1=require("flat"),glob=__importStar(require("glob")),getScopeAndLangFromFullPath_1=require("../helpers/getScopeAndLangFromFullPath"),logger_1=require("../helpers/logger"),readFile_1=require("../helpers/readFile"),writeFile_1=require("../helpers/writeFile"),messages_1=require("../messages"),buildTable_1=require("./buildTable"),getTranslationFilesPath_1=require("./getTranslationFilesPath");function compareKeysToFiles({scopeToKeys:e,translationPath:t,addMissingKeys:s,emitErrorOnExtraKeys:r}){const i=logger_1.getLogger();i.startSpinner(`${messages_1.messages.checkMissing} ✨`);const o={},n=getTranslationFilesPath_1.getTranslationFilesPath(t);let a=[];const l=transloco_utils_1.getConfig().scopePathMap||{};for(const[t,s]of Object.entries(l)){const r=e[t];r&&a.push({keys:r,scope:t,translationPath:s,files:glob.sync(`${s}/*.json`)})}const c={};for(const s of n){const{scope:r="__global"}=getScopeAndLangFromFullPath_1.getScopeAndLangFromFullPath(s,t);if(c[r])continue;c[r]=!0;const i=r?e[r]:e.__global;if(i){const e="__global"===r;a.push({keys:i,scope:r,translationPath:t,files:glob.sync(`${t}/${e?"":r}/*.json`)})}}for(const{files:e,keys:t,scope:r,translationPath:i}of a)for(const n of e){const{lang:e}=getScopeAndLangFromFullPath_1.getScopeAndLangFromFullPath(n,i),a=readFile_1.readFile(n,{parse:!0}),l=flat_1.flatten(a,{safe:!0}),c=deep_diff_1.diff(l,t);if(c){const i=`${"__global"!==r?r+"/":""}${e}`;o[i]={missing:[],extra:[]};for(const e of c)if("N"===e.kind)o[i].missing.push(e),s&&deep_diff_1.applyChange(a,t,e);else if("D"===e.kind){!e.path.join(".").endsWith(".comment")&&o[i].extra.push(e)}s&&writeFile_1.writeFile(n,a)}}i.success(`${messages_1.messages.checkMissing} ✨`);const g=Object.keys(o).filter(e=>{const{missing:t,extra:s}=o[e];return t.length||s.length});buildTable_1.buildTable({langs:g,diffsPerLang:o,addMissingKeys:s,emitErrorOnExtraKeys:r})}exports.compareKeysToFiles=compareKeysToFiles;