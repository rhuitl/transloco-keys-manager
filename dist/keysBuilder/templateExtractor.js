"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.templateExtractor=void 0;const cheerio=__importStar(require("cheerio")),config_1=require("../config"),readFile_1=require("../helpers/readFile"),regexs_1=require("../regexs"),types_1=require("../types"),addKey_1=require("./addKey"),commentsSectionExtractor_1=require("./commentsSectionExtractor"),forEachKey_1=require("./forEachKey"),getStructuralDirectiveBasedKeys_1=require("./getStructuralDirectiveBasedKeys"),resolveAliasAndKey_1=require("./resolveAliasAndKey");function getNgTemplateContainers(e){const t=e.match(/<ng-template[^>]*transloco[^>]*>/),r=e.includes("*transloco"),n=[];return t&&n.push("ng-template[transloco]"),r&&n.push("[__transloco]"),{containers:n,hasStructural:r}}function keepMarkingCommentsOnly(e){const{marker:t}=config_1.getConfig(),r=regexs_1.regexs.templateValidComment(t);return e.replace(regexs_1.regexs.templateCommentsSection(),e=>r.test(e)?e:"")}function removeInnerContainers(e,t){return t.filter(({containerContent:t})=>e!==t&&e.includes(t)).reduce((e,{containerContent:t})=>e.replace(t,""),e)}function loadCheerio(e){return cheerio.load(e,{decodeEntities:!1})}function templateExtractor({file:e,scopes:t,defaultValue:r,scopeToKeys:n}){let o=readFile_1.readFile(e);if(!o.includes("transloco"))return n;o=keepMarkingCommentsOnly(o);let a=[];const s={defaultValue:r,scopes:t,scopeToKeys:n},{containers:i,hasStructural:c}=getNgTemplateContainers(o);if(i.length>0){const e=loadCheerio(c?o.replace(/\*transloco/g,"__transloco"):o);for(const r of i)e(r).each((r,n)=>{const o=n.attribs.__transloco?types_1.TEMPLATE_TYPE.STRUCTURAL:types_1.TEMPLATE_TYPE.NG_TEMPLATE,i=e(n).html(),{translationKeys:c,read:l}=getStructuralDirectiveBasedKeys_1.getStructuralDirectiveBasedKeys(n,o,i);if(a.push({containerContent:i,read:l}),Array.isArray(c))for(const e of c){const r=l?`${l}.${e}`:e;let[n,o]=resolveAliasAndKey_1.resolveAliasAndKey(r,t);n&&(o||(n=r),addKey_1.addKey(Object.assign(Object.assign({},s),{keyWithoutScope:n,scopeAlias:o})))}})}[regexs_1.regexs.directive(),regexs_1.regexs.directiveTernary(),regexs_1.regexs.pipe()].forEach(e=>{forEachKey_1.forEachKey(o,e,e=>{const[r,n]=resolveAliasAndKey_1.resolveAliasAndKey(e,t);addKey_1.addKey(Object.assign(Object.assign({},s),{keyWithoutScope:r,scopeAlias:n}))})});const l=Object.assign({regex:regexs_1.regexs.templateCommentsSection},s);return a.push({containerContent:loadCheerio(o).html(),read:""}),a.forEach(({containerContent:e,read:t},r,n)=>{commentsSectionExtractor_1.extractCommentsValues(Object.assign({read:t,content:removeInnerContainers(e,n)},l))}),n}exports.templateExtractor=templateExtractor;